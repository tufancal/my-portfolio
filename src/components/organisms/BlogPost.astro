---
import {
  storyblokEditable,
  type SbBlokData,
  renderRichText,
  type StoryblokRichTextNode,
} from "@storyblok/astro";
import type { BlogPost } from "@/.storyblok/types/285719928053161/storyblok-components";
import { formatDate, formatDateTime } from "@/src/utils/date";
import { Image } from "astro:assets";
import { generateResponsiveImageData } from "@/src/utils/optimizeImage";

interface Props {
  blok: BlogPost;
  publishedAt: string;
}

const { blok, publishedAt } = Astro.props;

// Extract headline anchor IDs for table of contents
const headlineAnchorIds =
  blok.copy.content
    ?.filter((item) => item.type === "heading")
    .map((heading) => {
      const anchorMark = heading.content?.[0]?.marks?.find(
        (mark) => mark.type === "anchor",
      );
      return { id: anchorMark?.attrs?.id, text: heading.content?.[0]?.text };
    })
    .filter((anchorId) => anchorId !== null && anchorId !== undefined) || [];

// Generate responsive image data
const image = generateResponsiveImageData(blok.image.filename as string, {
  breakpoints: [240, 320, 400, 560, 800, 1024, 1280],
  aspectRatio: 3 / 2,
  sizes:
    "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, (max-width: 1280px) 33vw, 400px",
});
---

<article
  class="container mx-auto max-w-3xl px-4"
  {...storyblokEditable(blok as SbBlokData)}
>
  <!-- Article metadata -->
  <div class="flex flex-col items-center gap-2 mb-6">
    <div class="badge badge-outline">
      <time datetime={formatDateTime(publishedAt)}>
        {formatDate(publishedAt)}
      </time>
    </div>
    <div class="badge badge-ghost">
      {blok.author}
    </div>
  </div>

  <!-- Headline -->
  <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-center text-base-content mb-8">
    {blok.headline}
  </h1>

  <!-- Hero image -->
  <figure class="mb-8 rounded-lg overflow-hidden shadow-md">
    <Image class="w-full" src={image.src} alt={blok.image.alt} inferSize />
  </figure>

  <!-- Intro text -->
  <div class="text-lg font-semibold text-base-content mb-8 leading-relaxed">
    <Fragment
      set:html={renderRichText(blok.introText as StoryblokRichTextNode)}
    />
  </div>

  <!-- Table of contents (if anchors exist) -->
  {
    headlineAnchorIds.length > 0 && (
      <div class="card bg-base-200 mb-8">
        <div class="card-body">
          <h2 class="card-title text-base-content">Table of Contents</h2>
          <ul class="menu menu-sm">
            {headlineAnchorIds.map((anchor) => (
              <li>
                <a href={`#${anchor.id}`} class="link link-hover">
                  {anchor.text}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </div>
    )
  }

  <!-- Main content with typography -->
  <div class="prose lg:prose-lg max-w-none prose-headings:text-base-content prose-p:text-base-content prose-a:text-primary prose-strong:text-base-content prose-code:text-base-content">
    <Fragment
      set:html={renderRichText(blok.copy as StoryblokRichTextNode, {
        optimizeImages: {
          width: 1024,
          height: 576,
          loading: "lazy",
          filters: {
            format: "webp",
            quality: 85,
          },
          srcset: [320, 640, 768, 1024, 1280],
          sizes: [
            "(max-width: 640px) 100vw",
            "(max-width: 1024px) 80vw",
            "1024px",
          ],
        },
      })}
    />
  </div>
</article>
